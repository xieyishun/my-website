---
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import PostCard from '../../components/PostCard.astro';
import { withBase } from '../../utils/url';
import { SITE_TITLE } from '../../consts';
import { slugify } from '../../utils/slug';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const set = new Set<string>();

  for (const p of posts) {
    for (const s of (p.data.series ?? [])) {
      const series = String(s).trim();
      if (series) set.add(series);
    }
  }

  const names = Array.from(set);

  return names.map((series) => ({
    // ✅ 关键：URL 参数用 slugify，与你现在页面里生成的 zh-xxxxxxxx 保持一致
    params: { series: slugify(series) }, // ✅ 必须叫 series
    // ✅ props 仍然传原始 series 名称，方便页面展示/筛选
    props: { series },
  }));
}

// 你路由里的参数（slug）
const seriesSlug = Astro.params.series as string;

// props 里是原始的 series 名称（用于展示）
const { series: seriesNameFromProps } = Astro.props as { series: string };

// 为了稳妥：用 slug 反查一次，确保“展示名”和“URL slug”绝对对应
const allPosts = await getCollection('blog');
const nameBySlug = new Map<string, string>();

for (const p of allPosts) {
  for (const s of (p.data.series ?? [])) {
    const name = String(s).trim();
    if (!name) continue;

    const slug = slugify(name);
    // 如果遇到碰撞，保留第一个即可（slugify 含 hash，碰撞概率极低）
    if (!nameBySlug.has(slug)) nameBySlug.set(slug, name);
  }
}

const series = nameBySlug.get(seriesSlug) ?? seriesNameFromProps;

// 排序（保持你原逻辑）
const posts = allPosts
  .slice()
  .sort((a, b) => {
    const ad = (a.data.updatedDate ?? a.data.pubDate).valueOf();
    const bd = (b.data.updatedDate ?? b.data.pubDate).valueOf();
    return bd - ad;
  });

// ✅ 过滤：用 slugify 对比 slug，而不是 includes(原始名)
// 这样无论 series 含中文/空格/符号，都能稳定匹配
const seriesPosts = posts.filter((p) => {
  const list = (p.data.series ?? []).map((x) => slugify(String(x).trim()));
  return list.includes(seriesSlug);
});
---

<!doctype html>
<html lang="zh-CN">
  <head>
    <BaseHead title={`${series} | Series | ${SITE_TITLE}`} description={`专题：${series}`} />
    <style>
      main { width: 960px; }
      .back {
        display: inline-block;
        margin: 1rem 0;
        text-decoration: none;
        color: rgb(var(--accent));
      }
      .back:hover { text-decoration: underline; }
      .list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 1.25rem;
      }
      .empty { color:#666; text-align:center; padding: 2rem 0; }
      @media (max-width: 720px) { main { width: 100%; } }
    </style>
  </head>

  <body>
    <Header />

    <main>
      <a class="back" href={withBase('/series/')}>← 返回专题列表</a>
      <h1>{series}</h1>
      <p style="color:#666;">共 {seriesPosts.length} 篇</p>

      {seriesPosts.length > 0 ? (
        <ul class="list">
          {seriesPosts.map((post) => (
            <PostCard post={post} showTags={true} />
          ))}
        </ul>
      ) : (
        <div class="empty">暂无文章</div>
      )}
    </main>

    <Footer />
  </body>
</html>