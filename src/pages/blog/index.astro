---
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import PostCard from '../../components/PostCard.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../../consts';
import '../../styles/blog-index.css';

const posts = (await getCollection('blog'))
  .slice()
  .sort((a, b) => {
    const ad = (a.data.updatedDate ?? a.data.pubDate).valueOf();
    const bd = (b.data.updatedDate ?? b.data.pubDate).valueOf();
    return bd - ad;
  });

// ✅ 从文章中提取 option（避免写死）
const typeSet = new Set<string>();
const gameSet = new Set<string>();
const regionSet = new Set<string>();

for (const p of posts) {
  if (p.data.type) typeSet.add(String(p.data.type));
  if (p.data.game) gameSet.add(String(p.data.game));
  const regions =
    Array.isArray((p.data as any).regions) ? (p.data as any).regions :
    Array.isArray((p.data as any).region) ? (p.data as any).region :
    [];
  for (const r of regions) regionSet.add(String(r));
}

const typeOptions = Array.from(typeSet).sort((a, b) => a.localeCompare(b, 'zh-CN'));
const gameOptions = Array.from(gameSet).sort((a, b) => a.localeCompare(b, 'zh-CN'));
const regionOptions = Array.from(regionSet).sort((a, b) => a.localeCompare(b, 'zh-CN'));
---

<!doctype html>
<html lang="zh-CN">
  <head>
    <BaseHead title={`Blog | ${SITE_TITLE}`} description={SITE_DESCRIPTION} />
  </head>

  <body>
    <Header />

    <main id="main-content">
      <h1>全部文章</h1>
      <p style="color:#666;">支持关键词搜索 + 类型/游戏/地区筛选 + 排序（纯前端，不影响静态构建）</p>

      <div class="toolbar">
        <div class="field">
          <label for="q">搜索</label>
          <input id="q" type="search" placeholder="标题 / 摘要 / 标签…" aria-label="搜索文章" />
        </div>

        <div class="field">
          <label for="type">类型</label>
          <select id="type" aria-label="按类型筛选">
            <option value="all">全部</option>
            {typeOptions.map((t) => <option value={t}>{t}</option>)}
          </select>
        </div>

        <div class="field">
          <label for="game">游戏</label>
          <select id="game" aria-label="按游戏筛选">
            <option value="all">全部</option>
            {gameOptions.map((g) => <option value={g}>{g}</option>)}
          </select>
        </div>

        <div class="field">
          <label for="region">地区</label>
          <select id="region" aria-label="按地区筛选">
            <option value="all">全部</option>
            {regionOptions.map((r) => <option value={r}>{r}</option>)}
          </select>
        </div>

        <div class="field">
          <label for="sort">排序</label>
          <select id="sort" aria-label="排序方式">
            <option value="new">最新发布</option>
            <option value="old">最早发布</option>
            <option value="updated">最近更新</option>
          </select>
        </div>
      </div>

      <div class="meta">
        <span id="count">共 {posts.length} 篇</span>
      </div>

      {posts.length > 0 ? (
        <ul class="list" id="list">
          {posts.map((post) => (
            <PostCard post={post} showTags={true} />
          ))}
        </ul>
      ) : (
        <div class="empty">暂无文章</div>
      )}
    </main>

    <Footer />

    <script>
      // —— 纯前端筛选/排序：不影响静态构建 ——

      /** @param {string} id */
      const getEl = (id) => document.getElementById(id);

      const qEl = /** @type {HTMLInputElement | null} */ (getEl("q"));
      const typeEl = /** @type {HTMLSelectElement | null} */ (getEl("type"));
      const gameEl = /** @type {HTMLSelectElement | null} */ (getEl("game"));
      const regionEl = /** @type {HTMLSelectElement | null} */ (getEl("region"));
      const sortEl = /** @type {HTMLSelectElement | null} */ (getEl("sort"));
      const countEl = /** @type {HTMLElement | null} */ (getEl("count"));
      const listEl = /** @type {HTMLElement | null} */ (getEl("list"));

      if (!qEl || !typeEl || !gameEl || !regionEl || !sortEl || !countEl || !listEl) {
        console.warn("[blog] Missing filter DOM elements.");
      } else {
        // 读取 querystring 初始化
        const params = new URLSearchParams(location.search);

        /**
         * @param {HTMLInputElement | HTMLSelectElement} el
         * @param {string} key
         * @param {string} fallback
         */
        const init = (el, key, fallback = "") => {
          const v = params.get(key);
          if (v != null) el.value = v;
          else if (fallback) el.value = fallback;
        };

        init(qEl, "q", "");
        init(typeEl, "type", "all");
        init(gameEl, "game", "all");
        init(regionEl, "region", "all");
        init(sortEl, "sort", "new");

        // ✅ 一次性读取 DOM / dataset，后续不再 querySelectorAll
        const items = Array.from(listEl.querySelectorAll("li.post-card")).map((node) => {
          const li = /** @type {HTMLElement} */ (node);

          const title = li.querySelector(".post-title")?.textContent?.trim() ?? "";
          const desc = li.querySelector(".post-desc")?.textContent?.trim() ?? "";
          const badges = Array.from(li.querySelectorAll(".post-badge")).map(
            (b) => b.textContent?.trim() ?? ""
          );

          const pub = Number(li.dataset.pub || 0);
          const updated = Number(li.dataset.updated || 0);

          const type = li.dataset.type || "analysis";
          const game = li.dataset.game || "";
          const regions = (li.dataset.regions || "")
            .split(",")
            .map((s) => s.trim())
            .filter(Boolean);

          const hay = `${title}\n${desc}\n${badges.join(" ")}`.toLowerCase();
          return { li, pub, updated, hay, type, game, regions };
        });

        // ✅ debounce：避免输入时频繁重排
        const debounce = (fn, ms = 120) => {
          let t = 0;
          return (...args) => {
            clearTimeout(t);
            t = setTimeout(() => fn(...args), ms);
          };
        };

        // ✅ 记住上一次排序结果签名；不变就不重排 DOM
        let lastSig = "";

        const apply = () => {
          const qRaw = (qEl.value || "").trim();
          const q = qRaw.toLowerCase();
          const type = typeEl.value;
          const game = gameEl.value;
          const region = regionEl.value;
          const sort = sortEl.value;

          // 更新 URL（不刷新）
          const next = new URLSearchParams();
          if (qRaw) next.set("q", qRaw);
          if (type !== "all") next.set("type", type);
          if (game !== "all") next.set("game", game);
          if (region !== "all") next.set("region", region);
          if (sort !== "new") next.set("sort", sort);

          const nextQs = next.toString();
          const nextUrl = `${location.pathname}${nextQs ? "?" + nextQs : ""}`;
          if (nextUrl !== location.pathname + location.search) {
            history.replaceState(null, "", nextUrl);
          }

          // 过滤（减少临时对象创建）
          const filtered = [];
          for (const it of items) {
            if (q && !it.hay.includes(q)) continue;
            if (type !== "all" && it.type !== type) continue;
            if (game !== "all" && it.game !== game) continue;
            if (region !== "all" && !it.regions.includes(region)) continue;
            filtered.push(it);
          }

          // 排序（就地排序）
          filtered.sort((a, b) => {
            if (sort === "old") return a.pub - b.pub;
            if (sort === "updated") {
              const au = a.updated || a.pub;
              const bu = b.updated || b.pub;
              return bu - au;
            }
            return b.pub - a.pub; // new
          });

          // 只有顺序变了才重排 DOM
          const sig = filtered.map((x) => x.pub + ":" + (x.updated || 0)).join("|");
          if (sig !== lastSig) {
            lastSig = sig;
            const frag = document.createDocumentFragment();
            for (const it of filtered) frag.appendChild(it.li);
            listEl.replaceChildren(frag);
          }

          countEl.textContent = `共 ${filtered.length} 篇`;
        };

        const applyDebounced = debounce(apply, 120);

        qEl.addEventListener("input", applyDebounced);
        [typeEl, gameEl, regionEl, sortEl].forEach((el) =>
          el.addEventListener("change", apply)
        );

        apply();
      }
    </script>
  </body>
</html>