---
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import PostCard from '../../components/PostCard.astro';
import { withBase } from '../../utils/url';
import { SITE_TITLE } from '../../consts';
import { slugify } from '../../utils/slug';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const set = new Set<string>();

  for (const p of posts) {
    for (const t of (p.data.tags ?? [])) {
      const tag = String(t).trim();
      if (tag) set.add(tag);
    }
  }

  return Array.from(set).map((tag) => ({
    params: { tag: slugify(tag) }, // ✅ 关键：用 slugify
    props: { tag },
  }));
}

const tagSlug = Astro.params.tag as string;
const { tag: tagNameFromProps } = Astro.props as { tag: string };

// 反查：slug -> 原始 tag 名称（用于展示）
const allPosts = await getCollection('blog');
const nameBySlug = new Map<string, string>();

for (const p of allPosts) {
  for (const t of (p.data.tags ?? [])) {
    const name = String(t).trim();
    if (!name) continue;

    const slug = slugify(name);
    if (!nameBySlug.has(slug)) nameBySlug.set(slug, name);
  }
}

const tag = nameBySlug.get(tagSlug) ?? tagNameFromProps;

// 排序（跟你 series 保持一致）
const posts = allPosts
  .slice()
  .sort((a, b) => {
    const ad = (a.data.updatedDate ?? a.data.pubDate).valueOf();
    const bd = (b.data.updatedDate ?? b.data.pubDate).valueOf();
    return bd - ad;
  });

// ✅ 过滤：用 slugify 对比 tagSlug
const tagPosts = posts.filter((p) => {
  const list = (p.data.tags ?? []).map((x) => slugify(String(x).trim()));
  return list.includes(tagSlug);
});
---

<!doctype html>
<html lang="zh-CN">
  <head>
    <BaseHead title={`${tag} | Tag | ${SITE_TITLE}`} description={`标签：${tag}`} />
    <style>
      main { width: 960px; }
      .back {
        display: inline-block;
        margin: 1rem 0;
        text-decoration: none;
        color: rgb(var(--accent));
      }
      .back:hover { text-decoration: underline; }
      .list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 1.25rem;
      }
      .empty { color:#666; text-align:center; padding: 2rem 0; }
      @media (max-width: 720px) { main { width: 100%; } }
    </style>
  </head>

  <body>
    <Header />

    <main>
      <a class="back" href={withBase('/tags/')}>← 返回标签列表</a>
      <h1>{tag}</h1>
      <p style="color:#666;">共 {tagPosts.length} 篇</p>

      {tagPosts.length > 0 ? (
        <ul class="list">
          {tagPosts.map((post) => (
            <PostCard post={post} showTags={true} />
          ))}
        </ul>
      ) : (
        <div class="empty">暂无文章</div>
      )}
    </main>

    <Footer />
  </body>
</html>