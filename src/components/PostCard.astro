---
import type { CollectionEntry } from 'astro:content';
import FormattedDate from './FormattedDate.astro';
import { withBase } from '../utils/url';

type TypeValue = 'note' | 'analysis' | 'report';

interface Props {
  post: CollectionEntry<'blog'>;
  showTags?: boolean;
  currentTag?: string;
  maxTags?: number;
  showSummary?: boolean;
}

const {
  post,
  showTags = false,
  currentTag = '',
  maxTags = 6,
  showSummary = true,
} = Astro.props;

const typeLabelMap: Record<TypeValue, string> = {
  note: '笔记',
  analysis: '分析',
  report: '报告',
};

const typeValue = (post.data.type ?? 'analysis') as TypeValue | string;
const typeLabel =
  typeValue in typeLabelMap ? typeLabelMap[typeValue as TypeValue] : String(typeValue ?? '');

const game = (post.data.game ?? '').trim();

// 兼容 region/regions 两种写法
const regionsRaw =
  Array.isArray((post.data as any).regions) ? (post.data as any).regions :
  Array.isArray((post.data as any).region) ? (post.data as any).region :
  [];
const regions = regionsRaw.map((x: any) => String(x).trim()).filter(Boolean);

const tagsAll = Array.isArray(post.data.tags) ? post.data.tags : [];
const tags = showTags ? tagsAll.slice(0, maxTags) : [];

const summary = (post.data.summary ?? '').trim();
const desc = (post.data.description ?? '').trim();
const excerpt = showSummary ? (summary || desc) : desc;

const href = withBase(`/blog/${post.id}/`);

// ✅ 封面图（可选，string）：推荐写 /covers/xxx.jpg 放 public/ 下
const cover = String((post.data as any).image ?? '').trim();
const coverAlt = (post.data as any).imageAlt
  ? String((post.data as any).imageAlt).trim()
  : String(post.data.title ?? '').trim();

// ✅ 关键：兼容子路径 base
// - 外链（http/https）原样用
// - 站内路径（/covers/xx.jpg 或 covers/xx.jpg）自动 withBase
const isHttp = (s: string) => s.startsWith('http://') || s.startsWith('https://');
const coverSrc = cover
  ? (isHttp(cover) ? cover : withBase(cover.startsWith('/') ? cover : `/${cover}`))
  : '';
---

<li
  class="post-card"
  data-pub={post.data.pubDate.valueOf()}
  data-updated={post.data.updatedDate ? post.data.updatedDate.valueOf() : ''}
  data-type={String(post.data.type ?? 'analysis')}
  data-game={game}
  data-regions={regions.join(',')}
>
  {coverSrc && (
    <a class="cover-link" href={href} aria-label={`打开文章：${post.data.title}`}>
      <div class="cover">
        <img
          class="cover-img"
          src={coverSrc}
          alt={coverAlt}
          loading="lazy"
          decoding="async"
        />
      </div>
    </a>
  )}

  <a class="title-link" href={href}>
    <h3 class="post-title">{post.data.title}</h3>
  </a>

  {excerpt && <p class="post-desc">{excerpt}</p>}

  <div class="post-meta">
    <span class="post-date">
      <FormattedDate date={post.data.pubDate} />
    </span>
    {post.data.updatedDate && (
      <span class="post-updated">
        更新于 <FormattedDate date={post.data.updatedDate} />
      </span>
    )}
  </div>

  <div class="post-badges">
    {typeLabel && <span class="post-badge">{typeLabel}</span>}
    {game && <span class="post-badge">{game}</span>}
    {regions.map((r) => (
      <span class="post-badge">{r}</span>
    ))}

    {showTags &&
      tags.map((t) => (
        <a
          href={withBase(`/tags/${encodeURIComponent(t)}/`)}
          class={`post-badge post-badge-link ${t === currentTag ? 'current' : ''}`}
        >
          {t}
        </a>
      ))}

    {showTags && tagsAll.length > maxTags && (
      <span class="post-badge post-badge-muted">+{tagsAll.length - maxTags}</span>
    )}
  </div>
</li>

<style>
  .post-card {
    padding: 1.2rem 1.1rem;
    border: 1px solid #e9e9e9;
    border-radius: 14px;
    background: #fff;
  }

  /* ✅ 封面容器固定比例：减少 CLS */
  .cover-link {
    display: block;
    text-decoration: none;
    color: inherit;
    margin: 0 0 0.85rem 0;
  }
  .cover {
    width: 100%;
    border-radius: 12px;
    overflow: hidden;
    background: #f2f2f2;
    aspect-ratio: 16 / 9;
  }
  .cover-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .title-link {
    text-decoration: none;
    color: inherit;
  }

  .post-title {
    margin: 0 0 0.5rem;
    font-size: 1.25rem;
    line-height: 1.25;
  }

  .post-desc {
    margin: 0;
    color: #555;
    font-size: 0.98rem;
    line-height: 1.7;
  }

  .post-meta {
    margin-top: 0.65rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.9rem;
    color: #666;
    font-size: 0.9rem;
  }

  .post-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin-top: 0.6rem;
  }

  .post-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.15rem 0.6rem;
    border-radius: 999px;
    background-color: #f3f3f3;
    color: #333;
    font-size: 0.75rem;
    line-height: 1.4;
    transition: background-color 0.2s ease, color 0.2s ease;
  }

  .post-badge-link {
    text-decoration: none;
  }

  .post-badge:hover {
    background-color: #e7e7e7;
  }

  .post-badge.current {
    background-color: #333;
    color: #fff;
  }

  .post-badge-muted {
    background: #f0f0f0;
    color: #666;
  }
</style>